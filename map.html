<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propriétés sur la Carte</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <h1>Propriétés sur la Carte</h1>
    </header>
    <div id="map"></div>
    <div class="circle-overlay close"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        window.onload = function() {
            var overlay = document.querySelector('.circle-overlay');

            // Ajouter la classe pour démarrer l'animation inverse
            setTimeout(function() {
                overlay.classList.add('shrink');
            }, 10);

            // Supprimer l'overlay après l'animation de fermeture
            setTimeout(function() {
                overlay.remove(); // Retire le cercle une fois l'animation terminée
            }, 1500); // Durée de l'animation de fermeture
        };

        const map = L.map('map', {
            center: [46.603354, 1.888334], // Centre de la France
            zoom: 6,
            minZoom: 6,
            maxBounds: [
                [41.3337, -5.5591], // Sud-Ouest (Latitude/Longitude min)
                [51.1241999, 9.6624999]  // Nord-Est (Latitude/Longitude max)
            ],
            maxBoundsViscosity: 1.0 // Empêche la carte de sortir de ces limites
        });

        // Charger le fond de carte OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Charger le fichier GeoJSON pour la France
        fetch('json/fr.json') // Chemin vers ton fichier GeoJSON
            .then(response => response.json())
            .then(data => {
                const geoJsonLayer = L.geoJSON(data, {
                    style: {
                        color: "#3388ff",
                        weight: 2,
                        fillOpacity: 0
                    }
                }).addTo(map);

                // Ajuster la vue pour englober les limites de la France
                map.fitBounds(geoJsonLayer.getBounds());

                // Ajouter un masque autour de la France pour cacher tout sauf la France
                addMaskOutsideFrance(map, geoJsonLayer);
            })
            .catch(error => console.error('Erreur lors du chargement du fichier GeoJSON:', error));

        // Fonction pour ajouter le masque en dehors de la France
        function addMaskOutsideFrance(map, geoJsonLayer) {
            // Définir les coordonnées du "monde" (grand polygone qui couvre tout)
            const worldMask = [
                [[-90, -180], [90, -180], [90, 180], [-90, 180]]
            ];

            // Obtenir les coordonnées de la France
            const franceCoordinates = geoJsonLayer.getLayers().map(layer => {
                return layer.getLatLngs();
            });

            // Combiner les deux pour créer un masque
            const mask = L.polygon([...worldMask, ...franceCoordinates], {
                color: '#000000',    // Contour du masque
                fillColor: '#000000', // Couleur de remplissage en dehors de la France
                fillOpacity: 0.9,    // Opacité du masque (0.8 pour un fond presque opaque)
                stroke: false        // Pas de contour autour du masque
            }).addTo(map);
        }


        // Fonction pour ajouter les marqueurs à partir des données de la base de données via PHP
        async function addMarkers() {
            try {
                // Charger les propriétés depuis la base de données avec PHP
                const response = await fetch('php/fetchfromjson.php');
                if (!response.ok) {
                    throw new Error(`Erreur de chargement des données: ${response.statusText}`);
                }
                const properties = await response.json();

                console.log(properties);

                // Ajouter un marqueur pour chaque propriété
                properties.forEach(property => {
                    const latitude = property.latitude;
                    const longitude = property.longitude;
                    const propertyType = property.propertyType || "Propriété";
                    const city = property.city || "Unknown City";
                    const postalCode = property.postalCode || "Unknown Postal Code";
                    const propertyUrl = property.propertyPricesUrl || "#";

                    if (latitude && longitude) {
                        const marker = L.marker([latitude, longitude]).addTo(map);

                        marker.bindPopup(`
                            <b>${propertyType}</b><br>
                            ${city}, ${postalCode}<br>
                            <a href="php/details.php?id=${property.id}">Voir l'annonce</a>
                        `);
                    }
                });
            } catch (error) {
                console.error("Erreur lors de l'ajout des marqueurs :", error);
            }
        }

        addMarkers();
    </script>
</body>
</html>
